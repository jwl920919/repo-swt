--==========================================================================================
-- DEVICE
--==========================================================================================

CREATE SEQUENCE device_id_seq;

-- DEVICE_INSIGHT
CREATE TABLE device_insight
(
  device_id integer NOT NULL DEFAULT nextval('device_id_seq'::regclass),
  site_id integer,
  host character varying(128) NOT NULL,
  port integer NOT NULL DEFAULT 0,
  version character varying(32),
  is_master boolean DEFAULT false,
  cluster_mode character varying(32),
  cluster_index integer,
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT device_insight_pkey PRIMARY KEY (device_id),
  CONSTRAINT device_insight_host_unique UNIQUE (host, port)
);

-- DEVICE_PROBE
CREATE TABLE device_probe
(
  device_id integer NOT NULL DEFAULT nextval('device_id_seq'::regclass),
  site_id integer NOT NULL,
  host character varying(128) NOT NULL,
  port integer NOT NULL DEFAULT 0,
  version character varying(32),
  enable_collect_cam boolean DEFAULT true,
  enable_control_ipv4 boolean DEFAULT false,
  enable_control_ipv6 boolean DEFAULT true,
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT device_probe_pkey PRIMARY KEY (device_id),
  CONSTRAINT device_probe_host_unique UNIQUE (host, port)
);

-- DEVICE_DHCP
CREATE TABLE device_dhcp
(
  device_id integer NOT NULL DEFAULT nextval('device_id_seq'::regclass),
  site_id integer NOT NULL,
  host character varying(128),
  device_name character varying(128),
  snmp_community character varying(64) DEFAULT '',
  snmp_version integer DEFAULT 2,
  vendor character varying(64),
  model character varying(128),
  sys_oid character varying(256),
  sys_location character varying(256),
  wapi_userid character varying(64),
  wapi_password character varying(256),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT device_dhcp_pkey PRIMARY KEY (device_id),
  CONSTRAINT device_dhcp_host_unique UNIQUE (host)
);

-- DEVICE_NETWORK
CREATE TABLE device_network
(
  device_id integer NOT NULL DEFAULT nextval('device_id_seq'::regclass),
  site_id integer NOT NULL,
  host character varying(128),
  device_type character varying(32) NOT NULL,
  snmp_community character varying(64) DEFAULT '',
  snmp_version integer DEFAULT 2,
  host_name character varying(128),
  vendor character varying(64),
  model character varying(128),
  service_type integer,
  sys_oid character varying(256),
  sys_location character varying(256),
  description character varying(512),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT device_network_pkey PRIMARY KEY (device_id),
  CONSTRAINT device_network_ip_unique UNIQUE (host)
);
COMMENT ON COLUMN device_network.device_type IS 'L2, L3, SWITCH, FIREWALL, ...';

--==========================================================================================
-- INTERFACE
--==========================================================================================

CREATE TABLE interface_info
(
  device_id integer NOT NULL,
  if_number integer NOT NULL,
  if_name character varying(128),
  if_desc character varying(256),
  if_speed integer NOT NULL,
  if_macaddr character varying(20),
  if_alias character varying(128),
  admin_stauts integer DEFAULT 0,
  oper_stauts integer DEFAULT 0,
  user_desc character varying(256),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT interface_info_pkey PRIMARY KEY (device_id, if_number)
);
COMMENT ON COLUMN interface_info.if_speed IS 'Mbps';


CREATE TABLE interface_ip
(
  device_id integer NOT NULL,
  if_number integer NOT NULL,
  if_ipaddr character varying(16),
  network_ip character varying(16),
  network_mask character varying(16),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT interface_ip_pkey PRIMARY KEY (device_id, if_number, if_ipaddr)
);

CREATE TABLE interface_cam
(
  device_id integer NOT NULL,
  if_number integer NOT NULL,
  macaddr character varying(18) NOT NULL DEFAULT '',
  ipaddr character varying(40),
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT interface_cam_pkey PRIMARY KEY (device_id, if_number, macaddr)
);
COMMENT ON COLUMN interface_cam.ipaddr IS 'IPv4 or IPv6';


CREATE TABLE interface_cam_history
(
  device_id integer NOT NULL,
  if_number integer NOT NULL,
  macaddr character varying(18) NOT NULL,
  ipaddr character varying(40),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT interface_cam_history_pkey PRIMARY KEY (device_id, if_number, macaddr, insert_time)
);

--==========================================================================================
-- SITE
--==========================================================================================

-- SITE_INFO
CREATE SEQUENCE public.site_info_id_seq;
CREATE TABLE public.site_info
(
  site_id integer NOT NULL DEFAULT nextval('site_info_id_seq'::regclass),
  site_name character varying(128) NOT NULL,
  site_code character varying(8) NOT NULL,
  description character varying(512),
  CONSTRAINT site_info_pkey PRIMARY KEY (site_id)
);

CREATE SEQUENCE public.site_blacklist_id_seq;
CREATE TABLE public.site_blacklist_info
(
  blacklist_id integer NOT NULL DEFAULT nextval('site_blacklist_id_seq'::regclass),
  site_id integer NOT NULL,
  blacklist_enable boolean DEFAULT false,
  blacklist_filter_name character varying(128) DEFAULT '',
  blacklist_time_sec integer DEFAULT 30,
  description character varying(512),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT site_blacklist_info_pkey PRIMARY KEY (blacklist_id)
);


--==========================================================================================
-- EVENT
--==========================================================================================

CREATE SEQUENCE public.event_id_seq;

-- EVENT_LOG
CREATE TABLE public.event_log
(
  event_id integer NOT NULL DEFAULT nextval('event_id_seq'::regclass),
  device_id integer,
  host_ip character varying(16),
  event_type character varying(32) NOT NULL,
  severity integer NOT NULL,
  collect_time timestamp with time zone DEFAULT current_timestamp,
  message character varying(512) NOT NULL,
  CONSTRAINT event_id_pkey PRIMARY KEY (event_id)
);
COMMENT ON COLUMN public.event_log.event_type IS 'syslog, ...';

CREATE INDEX event_log_idx ON public.event_log USING btree (device_id, collect_time);


--==========================================================================================
-- AUTH
--==========================================================================================

-- AUTH_TYPE
CREATE TABLE public.auth_type
(
  auth_type_id integer NOT NULL,
  auth_name character varying(64) NOT NULL,
  auth_type character varying(32) NOT NULL,
  CONSTRAINT auth_type_id_pkey PRIMARY KEY (auth_type_id)
);

-- AUTH_ORDER
CREATE TABLE public.auth_order
(
  site_id integer NOT NULL,
  sequence_type character varying(32) DEFAULT 'sequence',
  auth_type_id integer NOT NULL,
  auth_order integer NOT NULL,
  CONSTRAINT auth_order_id_pkey PRIMARY KEY (site_id, auth_type_id, auth_order)
);


-- AUTH_LDAP_GROUP
CREATE SEQUENCE public.auth_ldap_group_id_seq;
CREATE TABLE public.auth_ldap_group
(
  ldap_group_id integer NOT NULL DEFAULT nextval('auth_ldap_group_id_seq'::regclass),
  auth_type_id integer DEFAULT 1,
  domain_name character varying(512) NOT NULL,
  group_name character varying(512) NOT NULL,
  group_type character varying(64) NOT NULL,
  CONSTRAINT ldap_group_id_pkey PRIMARY KEY (ldap_group_id)
);

-- AUTH_SETUP_ID Sequence
CREATE SEQUENCE public.auth_setup_id_seq;

-- AUTH_SETUP_LDAP
CREATE TABLE public.auth_setup_ldap
(
  setup_id integer NOT NULL DEFAULT nextval('auth_setup_id_seq'::regclass),
  site_id integer NOT NULL,
  host character varying(64) NOT NULL,
  port integer NOT NULL,
  ssl_enable boolean NOT NULL DEFAULT false,
  
  auth_type character varying(32) NOT NULL,
  bind_domain character varying(128) NOT NULL,
  bind_passwd character varying(64) NOT NULL,
  base_domain character varying(128) NOT NULL,
  user_class character varying(128) NOT NULL,
  user_attr character varying(128) NOT NULL,
  user_name_attr character varying(128) NOT NULL,
  user_memberof_attr character varying(128) NOT NULL,
  
  group_class character varying(128) NOT NULL,
  group_name_attr character varying(128) NOT NULL,
  group_member_attr character varying(128) NOT NULL,
  
  kerberos_enable boolean NOT NULL DEFAULT false,
  kerberos_host character varying(64),
  kerberos_port integer,
  kerberos_realm character varying(128),
  
  CONSTRAINT auth_setup_ldap_id_pkey PRIMARY KEY (setup_id)
);

-- AUTH_SETUP_ESB
CREATE TABLE public.auth_setup_esb
(
  setup_id integer NOT NULL DEFAULT nextval('auth_setup_id_seq'::regclass),
  site_id integer NOT NULL,
  url character varying(256) NOT NULL,
  user_id character varying(64) NOT NULL,
  user_passwd character varying(64) NOT NULL,
  
  CONSTRAINT auth_setup_esb_id_pkey PRIMARY KEY (setup_id)
);

-- AUTH_SETUP_RADIUS
CREATE TABLE public.auth_setup_radius
(
  setup_id integer NOT NULL DEFAULT nextval('auth_setup_id_seq'::regclass),
  site_id integer NOT NULL,
  host character varying(64) NOT NULL,
  password character varying(128) NOT NULL,
  auth_port integer NOT NULL,
  acct_port integer NOT NULL,
  timeout_sec integer DEFAULT 3,
  nas_ip character varying(32) NOT NULL,
  nas_identifier character varying(64) NOT NULL,
  service_type character varying(64) DEFAULT 'Login-User',
  called_station_id character varying(64) NOT NULL,
  
  CONSTRAINT auth_setup_radius_id_pkey PRIMARY KEY (setup_id)
);


--==========================================================================================
-- DHCP
--==========================================================================================

-- DHCP NETWORK
CREATE TABLE public.dhcp_network
(
  site_id integer NOT NULL,
  network character varying(64) NOT NULL,
  ip_type character varying(18),
  start_ip character varying(40) NOT NULL,
  end_ip character varying(40) NOT NULL,
  start_num numeric,
  end_num numeric,
  ip_count numeric,
  comment character varying(256) NOT NULL,
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT dhcp_network_pkey PRIMARY KEY (site_id, network)
);

-- DHCP RANGE
CREATE TABLE public.dhcp_range
(
  site_id integer NOT NULL,
  network character varying(64) NOT NULL,
  ip_type character varying(18),
  start_ip character varying(40) NOT NULL,
  end_ip character varying(40) NOT NULL,
  start_num numeric,
  end_num numeric,
  ip_count numeric,
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT dhcp_range_pkey PRIMARY KEY (site_id, network, start_ip, end_ip)
);

-- DHCP_MAC_FILTER
CREATE TABLE public.dhcp_mac_filter
(
  site_id integer NOT NULL,
  filter_name character varying(128) NOT NULL,
  filter_desc character varying(512),
  insert_time timestamp with time zone DEFAULT current_timestamp,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT dhcp_mac_filter_pkey PRIMARY KEY (site_id, filter_name)
);

-- DHCP FIXED IP
CREATE TABLE public.dhcp_fixed_ip
(
  site_id integer NOT NULL,
  network character varying(64) NOT NULL,
  ipaddr character varying(40) NOT NULL,
  macaddr character varying(18),
  ip_type character varying(18),
  ip_num numeric NOT NULL,
  comment character varying(256),
  disable boolean DEFAULT false,
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT dhcp_fixed_ip_pkey PRIMARY KEY (site_id, ipaddr)
);


-- DHCP IP STATUS
CREATE TABLE dhcp_ip_status
(
  site_id integer NOT NULL,
  network character varying(64) NOT NULL,
  ipaddr character varying(40) NOT NULL,
  ip_type character varying(18),
  ip_num numeric NOT NULL,
  macaddr character varying(18),
  duid character varying(64),
  is_conflict boolean DEFAULT false,
  conflict_types character varying(16),
  status character varying(16),
  lease_state character varying(16),
  obj_types character varying(64),
  discover_status character varying(16),
  usage character varying(32),
  host_name character varying(128),
  host_os character varying(128),
  fingerprint character varying(128),
  is_never_ends boolean DEFAULT false,
  is_never_start boolean DEFAULT false,
  lease_start_time timestamp with time zone,
  lease_end_time timestamp with time zone,
  last_discovered timestamp with time zone,
  update_time timestamp with time zone DEFAULT current_timestamp,
  user_description character varying(256),
  CONSTRAINT dhcp_ip_status_pkey PRIMARY KEY (site_id, ipaddr)
);
COMMENT ON COLUMN dhcp_ip_status.ip_type IS 'IPV4, IPV6';
COMMENT ON COLUMN dhcp_ip_status.status IS 'The current status of the address (USED, UNUSED)';
COMMENT ON COLUMN dhcp_ip_status.lease_state IS '(ABANDONED, ACTIVE, BACKUP, DECLINED, EXPIRED, FREE, OFFERED, RELEASED, RESET, STATIC)';
COMMENT ON COLUMN dhcp_ip_status.conflict_types IS '(DEVICE_TYPE, DEVICE_VENDOR, DHCP_RANGE, DUID, MAC_ADDRESS, NONE, RESERVED_PORT, USED_RESERVED_PORT, VM_AFFILIATION)';
COMMENT ON COLUMN dhcp_ip_status.discover_status IS '(COMPLETED, NONE, PENDING, RUNNING)';
COMMENT ON COLUMN dhcp_ip_status.obj_types IS 'The types of associated objects (NETWORK, DHCP_RANGE, LEASE, FA, A,...)';
COMMENT ON COLUMN dhcp_ip_status.usage IS 'Indicates whether the IP address is configured for DNS or DHCP (DHCP,DNS)';


/*
-- DHCP_LEASE_IP
CREATE TABLE dhcp_lease_ip
(
  site_id integer NOT NULL,
  network character varying(64) NOT NULL,
  ipaddr character varying(40) NOT NULL,
  ip_type character varying(18),
  macaddr character varying(18),
  duid character varying(64),
  hostname character varying(64),
  state character varying(16),
  username character varying(64),
  fingerprint character varying(128),
  OS character varying(128),  
  lease_start_time timestamp with time zone,
  lease_end_time timestamp with time zone,
  last_discovered timestamp with time zone,
  description character varying(256),
  update_time timestamp with time zone DEFAULT current_timestamp,
  CONSTRAINT dhcp_lease_ip_pkey PRIMARY KEY (site_id, ipaddr)
);
COMMENT ON COLUMN dhcp_lease_ip.state IS 'ABANDONED, ACTIVE, BACKUP, DECLINED, EXPIRED, FREE, OFFERED, RELEASED, RESET, STATIC';
*/

/*
-- client_history
CREATE SEQUENCE client_id_seq;
CREATE TABLE public.client_history
(
  client_id integer NOT NULL DEFAULT nextval('client_id_seq'::regclass),
  
  macaddr character varying(18),
  duid character varying(64),
  
  segment_id integer NOT NULL,
  ipaddr character varying(40) NOT NULL,
  ip_type character varying(18),
  
  duid character varying(64),
  hostname character varying(64),
  state character varying(16),
  
  insert_time timestamp with time zone,
  
  CONSTRAINT client_history_pkey PRIMARY KEY (macaddr, duid, )
);
*/
